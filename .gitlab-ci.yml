image:
  name: registry.gitlab.com/fdroid/fdroidserver:buildserver
  entrypoint: [""]

before_script:
  - . /etc/profile.d/bsenv.sh
  - git clone --depth 1 https://gitlab.com/fdroid/fdroidserver.git "${fdroidserver}"
  - apt update; apt install --yes patch autoconf libtool pkg-config ant
  - GRADLE_USER_HOME=${home_vagrant}/.gradle
  - echo "$KEYSTORE" | base64 -d > fdroid/keystore.p12
  - chmod 600 fdroid/config.yml fdroid/keystore.p12

pages:
  stage: deploy
  script:
    - ./download.py
    - cd fdroid
    - ${fdroidserver}/fdroid update
    - mkdir /fdroid
    - ${fdroidserver}/fdroid deploy
    - cd ..
    - mkdir public
    - cp -vr /fdroid/* public/
    - rm -rf /public/archive
    - cp index.html public/repo/
  cache:
    key: repo-cache
    paths:
      - fdroid/repo/*
      - fdroid/stats/known_apks.txt
      - versioncache.json
  artifacts:
    paths:
      - public
    expire_in: 2 days
  only:
    - master
